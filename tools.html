<script>
// رابط الأدوات القديمة لتشغيلها مع pdf-lib
const { PDFDocument, degrees, rgb, StandardFonts } = PDFLib;

// أزرار اختيار الأدوات
document.querySelectorAll('.tool-btn[data-tool]').forEach(btn => {
  btn.addEventListener('click', () => {
    const tool = btn.dataset.tool;
    document.querySelectorAll('.tool-selector, .section-title, main > p').forEach(el => el.style.display = 'none');
    document.getElementById(`tool-${tool}`).style.display = 'block';
    document.getElementById('back-to-tools').style.display = 'block';
  });
});

// العودة إلى الأدوات
document.getElementById('back-to-tools').addEventListener('click', () => {
  document.querySelectorAll('.tool-section').forEach(el => el.style.display = 'none');
  document.getElementById('back-to-tools').style.display = 'none';
  document.querySelector('.tool-selector').style.display = 'grid';
  document.querySelector('.section-title').style.display = 'block';
  document.querySelector('main > p').style.display = 'block';
});

// دمج PDF
document.getElementById('btn-merge').onclick = async () => {
  const files = document.getElementById('merge-files').files;
  if (!files.length) return alert('اختر ملفات PDF');

  const mergedPdf = await PDFDocument.create();
  for (const file of files) {
    const pdf = await PDFDocument.load(await file.arrayBuffer());
    const pages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
    pages.forEach(p => mergedPdf.addPage(p));
  }
  const bytes = await mergedPdf.save();
  const blob = new Blob([bytes], { type: 'application/pdf' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'merged.pdf';
  a.click();
  document.getElementById('merge-status').textContent = 'تم الدمج';
};

// تقسيم PDF
document.getElementById('btn-split').onclick = async () => {
  const file = document.getElementById('split-file').files[0];
  const ranges = document.getElementById('split-ranges').value;
  if (!file || !ranges) return alert('اختر الملف وحدد الصفحات');

  const srcPdf = await PDFDocument.load(await file.arrayBuffer());
  const outPdf = await PDFDocument.create();
  ranges.split(',').forEach(r => {
    if (r.includes('-')) {
      let [s,e] = r.split('-').map(n => parseInt(n)-1);
      for (let i=s;i<=e;i++) outPdf.addPage(srcPdf.getPage(i));
    } else {
      outPdf.addPage(srcPdf.getPage(parseInt(r)-1));
    }
  });
  const bytes = await outPdf.save();
  const blob = new Blob([bytes], { type: 'application/pdf' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'extracted.pdf';
  a.click();
  document.getElementById('split-status').textContent = 'تم الاستخراج';
};

// تدوير PDF
document.getElementById('btn-rotate').onclick = async () => {
  const file = document.getElementById('rotate-file').files[0];
  const deg = parseInt(document.getElementById('rotate-degree').value);
  if (!file) return alert('اختر ملف');

  const pdf = await PDFDocument.load(await file.arrayBuffer());
  pdf.getPages().forEach(p => p.setRotation(degrees(p.getRotation().angle + deg)));
  const bytes = await pdf.save();
  const blob = new Blob([bytes], { type: 'application/pdf' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'rotated.pdf';
  a.click();
  document.getElementById('rotate-status').textContent = 'تم التدوير';
};

// علامة مائية
document.getElementById('btn-watermark').onclick = async () => {
  const file = document.getElementById('watermark-file').files[0];
  const text = document.getElementById('watermark-text').value;
  if (!file || !text) return alert('اختر الملف واكتب النص');

  const pdf = await PDFDocument.load(await file.arrayBuffer());
  const font = await pdf.embedFont(StandardFonts.HelveticaBold);
  pdf.getPages().forEach(p => {
    const { width, height } = p.getSize();
    p.drawText(text, { x: width/4, y: height/2, size: 40, font, color: rgb(.7,.7,.7), rotate: degrees(-45), opacity:.4 });
  });
  const bytes = await pdf.save();
  const blob = new Blob([bytes], { type: 'application/pdf' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'watermarked.pdf';
  a.click();
  document.getElementById('watermark-status').textContent = 'تمت الإضافة';
};
</script>
